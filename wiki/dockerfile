### Étape 1 – Build ###
FROM node:18-alpine AS build
WORKDIR /wiki

# Dépendances nécessaires juste pour build
RUN apk add --no-cache git python3 make g++ jq

# Variables build (vitales car Railway ne passe pas celles du runtime ici)
ENV NODE_ENV=production
ARG NODE_ENV=production

# Installer sans dev-deps pour un cache léger
COPY package.json yarn.lock ./
RUN jq '.dev = false' package.json >pkg.json && mv pkg.json package.json
RUN yarn install --frozen-lockfile --production

# Copier le code, builder les assets minifiés
COPY . .
RUN yarn build          # <-- minification + no sourcemaps

### Étape 2 – Runtime ###
FROM node:18-alpine
WORKDIR /wiki
ENV NODE_ENV=production

COPY --from=build /wiki ./

EXPOSE 3000             
CMD ["node", "server"]